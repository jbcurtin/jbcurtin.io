<html>
  <head>
    <title> Importing JSON-Data into PostgreSQL </title>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bulma-divider@0.2.0/dist/css/bulma-divider.min.css"/>
<link rel="stylesheet" type="text/css" href="../static/css/main.css" />
<link rel="stylesheet" type="text/css" href="../static/css/jupyter.css" />
<meta http-equiv="content-type" content="text/html; charset=utf-8">

<!-- Summary Content -->
<meta name="description" content="jbcurtin.io has scripts for managing massive amounts of data to help you or your organization focus more on science" />
<meta name="keywords" content="k8,kubenetes,gcp,aws,sklearn,mlops,machine learning operations,machine learning,ml,modelops,numpy,devops,etl,astronomy,science,dask" />
<meta name="author" content="Joe Curtin" />

<!-- mobile tags -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google SEO -->
<!-- Details: https://support.google.com/webmasters/answer/79812?hl=en -->
<meta name="googlebot" content="index" />

<!-- Open Graph -->
<!-- https://ogp.me/ -->
<meta property="og:title" content="Importing JSON-Data into PostgreSQL" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://jbcurtin.io/notebooks/data-import-postgresql.html" />
<meta property="og:description" content="# Importing JSON-Data into PostgreSQL

Parsing JSON files can be quick and efficient, importing them into PostgreSQL may take some time. In this article, we'll examine how to save compute resource time by pre-processing the JSON format into a CSV format with PSQL datatypes to be imported into PostgreSQL. This method seems to be the quickest way to import data into PostgreSQL" />
<meta property="og:locale" content="en_US" />
  </head>
  <body>
    <nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item navbar-icon" href="/">
<svg height='100px' width='100px'  fill="#000000" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><title>data_16</title><path d="M50.8400002,59.5200005h-1.4599991v10.3100014H42v16.0999985h16.0999985V69.8300018h-7.2599983V59.5200005z   M56.6399994,71.3000031v13.1699982H43.4700012V71.3000031H56.6399994z"></path><path d="M86.3300018,57.8600006V41.75H70.2300034v7.3699989h-8.4000015v-8.7799988H59v-7.5400009h5.7099991v7.3199997h16.0999985V24  H64.7099991v7.3199997h-7.1299973v0.7299995l0,0v8.2700005h-6.7400017V29.5200005h7.2700005V13.4200001H42v16.1000004h7.3699989  v10.8199997h-6.6299973v-8.2700005l0,0v-0.7299995h-7.1300011V24H19.5100002v16.0999985h16.1000004v-7.2999992h5.6699982v7.5400009  h-2.8799973v8.7900009h-8.5200024V41.75H13.7700005v16.0999985h16.1099987v-7.2599983h8.5200024v8.7900009h2.8800011v7.5399971  h-5.670002v-7.329998H19.5100002v16.1099968h16.1000004v-7.3199997h7.1300011v-0.7300034l0,0v-8.2699928h14.7899971v8.2700005l0,0  v0.7300034h7.1299973v7.3199921h16.1500015V59.5900002H64.7099991v7.3200035H59v-7.5300026h2.8300018v-8.7900009h8.4000015  v7.2700005H86.3300018z M71.6900024,43.2200012h13.1800003v13.1699982H71.6900024V43.2200012z M66.1699982,25.4799995h13.1800003  v13.1800003H66.1699982V25.4799995z M43.4699974,28.0599995V14.8800001h13.170002v13.1799994H43.4699974z M34.1499977,38.6599998H21  V25.4799995h13.1500015L34.1499977,38.6599998z M28.4200001,56.3899994H15.2399998V43.2200012h13.1800003V56.3899994z   M34.1500015,74.2299957H21V61.0600014h13.1500015V74.2299957z M66.1500015,61.0499954h13.1999969v13.1800079H66.1699982  L66.1500015,61.0499954z M60.3400002,57.909996H39.8699989V41.7999992h20.4900017L60.3400002,57.909996z"></path><rect x="53.7599983" y="49.1300011" width="1.4599991" height="1.4599991"></rect><rect x="49.3800011" y="49.1300011" width="1.4599991" height="1.4599991"></rect><rect x="45" y="49.1300011" width="1.4599991" height="1.4599991"></rect></svg>
    </a>

    <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>

  <div id="navbarBasicExample" class="navbar-menu">
    <div class="navbar-start">
      <div class="navbar-item has-dropdown is-hoverable">
        <a href="/recently-published-notebooks.html" class="navbar-link">
          Notebooks
        </a>

        <div class="navbar-dropdown">
          <a href="/recently-published-notebooks.html" class="navbar-item">
            Recently Published
          </a>
          <a target="_blank" href="https://forms.gle/9QBGGfPEVPBEMj1BA" class="navbar-item">
            Contact
          </a>
          <hr class="navbar-divider">
          <a target="_blank" href="https://github.com/jbcurtin/jbcurtin.io/blob/master/notebooks/README.md" class="navbar-item">
            Create Notebook
          </a>
        </div>
      </div>
    </div>
<div class="navbar-item field navbar-search">
  <p class="control has-icons-right">
    <input disabled="disabled" class="input" type="search" placeholder="Search by Notebok Name...">
    <span class="icon is-small is-right">
      <icon class="fas fa-search"/>
    </span>
  </p>
</div>
      <a href="/about.html" class="navbar-item disabled">
        Who is Joe Curtin?
      </a>

     <a class="navbar-item" href="https://github.com/jbcurtin/jbcurtin.io/issues" target="_blank">
Report Issue
     </a>

    <div class="navbar-end">
<!--
      <div class="navbar-item">
        <div class="buttons">
          <a class="button is-primary">
            <strong>Sign up</strong>
          </a>
          <a class="button is-light">
            Log in
          </a>
        </div>
      </div>
    </div>
-->
  </div>
</nav>


  <section class="hero is-medium is-bold">
    <div class="hero-body hero-image">
      <div class="container has-text-centered">
      </div>
    </div>
  </section>
  <section class="hero">
    <div class="hero-body">
      <h2 alt="Updated: Sunday, 14. June 2020 06:26PM" class="subtitle page-title"> Sunday, 09. August 2020 09:59PM </h2>
  <h1 class="title page-title"> Importing JSON-Data into PostgreSQL </h1>
      <div class="container">
        <section class="section">
          <div class="columns">
<div class="jupyter-notebook-styles content is-medium">

<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>Parsing JSON files can be quick and efficient, importing them into PostgreSQL may take some time. In this article, we'll examine how to save compute resource time by pre-processing the JSON format into a CSV format with PSQL datatypes to be imported into PostgreSQL. This method seems to be the quickest way to import data into PostgreSQL</p>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>Lets begin with grabbing the Yelp Dataset from <a href="https://www.kaggle.com/yelp-dataset/yelp-dataset" target="_blank">Yelp Dataset, on Kaggle</a></p>
<p>Once the Yelp Dataset is downloaded, move it to a workspace and unzip the files. You'll find a few JSON files</p>
<pre><code>-rw-r--r-- 1 nobody nobody 4809540040  6月 13 05:52 10100_1035793_bundle_archive.zip
-rw-r--r-- 1 nobody nobody      41776  3月 26 01:18 Dataset_Agreement.pdf
-rw-r--r-- 1 nobody nobody  152898689  3月 26 01:18 yelp_academic_dataset_business.json
-rw-r--r-- 1 nobody nobody  449663480  3月 26 01:18 yelp_academic_dataset_checkin.json
-rw-r--r-- 1 nobody nobody 6325565224  3月 26 01:19 yelp_academic_dataset_review.json
-rw-r--r-- 1 nobody nobody  263489322  3月 26 01:31 yelp_academic_dataset_tip.json
-rw-r--r-- 1 nobody nobody 3268069927  3月 26 01:32 yelp_academic_dataset_user.json</code></pre>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>So that our code works here in this notebook. We'll use fake-data in place of the real data</p>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [1]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">fake_data</span> <span class="o">=</span> <span class="s1">'''{"review_id":"xQY8N_XvtGbearJ5X4QryQ","user_id":"OwjRMXRC0KyPrIlcjaXeFQ","business_id":"-MhfebM0QIsKt87iDN-FNw","stars":2.0,"useful":5,"funny":0,"cool":0,"text":"Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.","date":"2015-04-15 05:21:16"}</span>
<span class="s1">{"review_id":"UmFMZ8PyXZTY2QcwzsfQYA","user_id":"nIJD_7ZXHq-FX8byPMOkMQ","business_id":"lbrU8StCq3yDfr-QMnGrmQ","stars":1.0,"useful":1,"funny":1,"cool":0,"text":"Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.", "date":"2013-12-07 03:16:52"}</span>
<span class="s1">{"review_id":"LG2ZaYiOgpr2DK_90pYjNw","user_id":"V34qejxNsCbcgD8C0HVk-Q","business_id":"HQl28KMwrEKHqhFrrDqVNQ","stars":5.0,"useful":1,"funny":0,"cool":0,"text":"Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.", "date":"2015-12-05 03:18:11"}</span>
<span class="s1">'''</span>
<span class="n">fake_data_filepath</span> <span class="o">=</span> <span class="s1">'yelp-fake-data.json'</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fake_data_filepath</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
  <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fake_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>Lets start with importing the libraries we'll need to run the codes, setup <code>logging</code> and create a few constants near the top of the file. The <code>logger</code> probably isn't needed in a Jupyter Notebook, I'll include it though because this post is about transforming data</p>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="n">sysHandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">sysHandler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">'</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">sysHandler</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">ENCODING</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'utf-8'</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>Create a function that'll help keep our transformed dataset clean of dumplicate records. <code>datum_hash</code> takes in a python-DICT and python-DICT-&gt;Keys and returns the hash. The Keys are required to maintain order of the dict-&gt;str encoding</p>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">insert_hash</span><span class="p">(</span><span class="n">datum</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">datum</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>The <code>convert_json_to_csv</code> function signature takes in a lot. <code>filepath</code> converts the <code>|-.json</code> path to <code>|-.csv</code> and will write the output into the same directory.
<code>unique_together</code> takes a list of keys which values will be comebined and hashed to create a unique hash. If the hashed-value is already know. It'll be omitted in the CSV output
<code>only_columns</code> trims down the output value to only the columns requested, or all the columns
<code>mutators</code> is a list of functions that'll accept and return string values for each propery specified
<code>extenders</code> is a list of functions that'll accept an array of rows, and extend the rows according to the data-type found in the rows[0]</p>
<p>With this, we have a fairly versatile script that'll give us uniform output for each JSON-entry in a file</p>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [27]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">convert_json_to_csv</span><span class="p">(</span>
    <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">unique_together</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">only_columns</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">mutators</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="s1">'key-name'</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">'function'</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">extenders</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="s1">'python-type'</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">'function'</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="n">csv_filepath</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Converting file: </span><span class="si">{</span><span class="n">csv_filepath</span><span class="si">}</span><span class="s1"> to CSV'</span><span class="p">)</span>
    <span class="n">csv_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">csv_filepath</span><span class="si">}</span><span class="s1">.csv'</span>
    <span class="n">inserts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">_write_rows</span><span class="p">(</span><span class="n">rows</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]],</span> <span class="n">writer</span><span class="p">:</span> <span class="s1">'csv.Writer'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">extender_list</span> <span class="ow">in</span> <span class="n">extenders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">extender</span> <span class="ow">in</span> <span class="n">extender_list</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">extender</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_stream</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">json_stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">datum</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_filepath</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_stream</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_stream</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">datum</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">only_columns</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">only_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">only_columns</span>

            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">unique_together</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">,</span> <span class="n">headers</span>

            <span class="n">headers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'created'</span><span class="p">)</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'guid'</span><span class="p">)</span>
            <span class="n">datum</span><span class="p">[</span><span class="s1">'guid'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">datum</span><span class="p">[</span><span class="s1">'created'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'2020-06-13 17:09:07.189521+00'</span>
            <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">mutator_list</span> <span class="ow">in</span> <span class="n">mutators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">mutator</span> <span class="ow">in</span> <span class="n">mutator_list</span><span class="p">:</span>
                    <span class="n">datum</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mutator</span><span class="p">(</span><span class="n">datum</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span>

            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">_write_rows</span><span class="p">([[</span><span class="n">datum</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">]],</span> <span class="n">writer</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_together</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">inserts</span><span class="p">[</span><span class="n">insert_hash</span><span class="p">(</span><span class="n">datum</span><span class="p">,</span> <span class="n">unique_together</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">json_stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">''</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="n">datum</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">datum</span><span class="p">[</span><span class="s1">'guid'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
                <span class="n">datum</span><span class="p">[</span><span class="s1">'created'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'2020-06-13 17:09:07.189521+00'</span>
                <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">mutator_list</span> <span class="ow">in</span> <span class="n">mutators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">mutator</span> <span class="ow">in</span> <span class="n">mutator_list</span><span class="p">:</span>
                        <span class="n">datum</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mutator</span><span class="p">(</span><span class="n">datum</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span>

                <span class="n">datum_hash</span> <span class="o">=</span> <span class="n">insert_hash</span><span class="p">(</span><span class="n">datum</span><span class="p">,</span> <span class="n">unique_together</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inserts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datum_hash</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_together</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">inserts</span><span class="p">[</span><span class="n">datum_hash</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">_write_rows</span><span class="p">([[</span><span class="n">datum</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">]],</span> <span class="n">writer</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_together</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">_write_rows</span><span class="p">([[</span><span class="n">datum</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">]],</span> <span class="n">writer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>Create the two utility functions that'll assist in converting the data from JSON-&gt;CSV</p>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [25]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">convert_datetime_to_psql</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">YELP_FORMAT</span> <span class="o">=</span> <span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S'</span>
    <span class="n">PSQL_FORMAT</span> <span class="o">=</span> <span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">+00'</span>
    <span class="n">stamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">YELP_FORMAT</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">PSQL_FORMAT</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extend_uniform_lists</span><span class="p">(</span><span class="n">rows</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">scalar_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)]</span>
        <span class="n">list_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">break</span>
            
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">clone</span> <span class="o">=</span> <span class="n">scalar_values</span><span class="p">[:]</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">list_values</span><span class="p">])</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clone</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>Invoke the conversion function</p>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [28]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">convert_json_to_csv</span><span class="p">(</span>
  <span class="n">fake_data_filepath</span><span class="p">,</span>
  <span class="p">[],</span>
  <span class="p">[],</span>
  <span class="p">{</span><span class="s1">'date'</span><span class="p">:</span> <span class="p">[</span><span class="n">convert_datetime_to_psql</span><span class="p">]},</span>
  <span class="p">{</span><span class="nb">list</span><span class="p">:</span> <span class="p">[</span><span class="n">extend_uniform_lists</span><span class="p">]})</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr">
<pre>2020-06-14 18:07:31,709 - __main__ - INFO - Converting file: /tmp/yelp-fake-data to CSV
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>Make sure we have some output in the CSV file</p>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [33]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">!</span>wc -l /tmp/yelp-fake-data.csv
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
<pre>4 /tmp/yelp-fake-data.csv
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput markdown-spacer" data-mime-type="text/markdown">
<p>Looking good! Go ahead an import it into a PSQL service with the following command,</p>
<pre><code>psql&gt; COPY review FROM '/tmp/yelp-fake-data.csv' CSV HEADER;</code></pre>
</div>
</div>

</div>
          </div>
        </section>
      </div>
    </div>
  </section>
    <footer></footer> 
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"></script>
<script defer src="../static/js/bulma.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89589148-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-89589148-1');
</script>
  </body>
</html>